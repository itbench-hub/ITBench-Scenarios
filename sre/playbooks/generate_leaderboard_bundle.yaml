---
- name: Manage SRE and FinOps Leaderboard Bundle
  hosts:
    - environment
  tasks:
    - name: Import docs role
      ansible.builtin.import_role:
        name: docs

    - name: Load spec and truth files
      ansible.builtin.set_fact:
        incidents: |
          {{
            (
              incidents | default([])
            ) +
            [
              {
                "spec": (lookup('ansible.builtin.file', spec_path) | from_yaml),
                "truth": (lookup('ansible.builtin.file', truth_path) | from_yaml)
              }
            ]
          }}
      loop: "{{ docs_incidents_ids | sort }}"
      loop_control:
        label: "incident-{{ item }}"
      tags:
        - always
      vars:
        spec_path: "{{ playbook_dir }}/../roles/incidents/files/specs/incident_{{ item }}.yaml"
        truth_path: "{{ playbook_dir }}/../roles/incidents/files/ground_truths/incident_{{ item }}.yaml"

    - name: Create bundle contents
      ansible.builtin.set_fact:
        bundle_contents:
          bundle:
            name: "{{ item.spec.name }}"
            path: ~/sre
            agent_operation_timeout: 1500
            bundle_ready_timeout: 3000
            params:
              INCIDENT_NUMBER: "{{ item.spec.id }}"
              location: ~/sre/roles/incidents
            scenario_type: SRE
            make_target_mapping:
              deploy:
                file: Makefile.runner
                target: launch_start_workflow
              inject_fault:
                unused: "{{ item.spec.faults | length == 0 }}"
              delete:
                file: Makefile.runner
                target: launch_stop_workflow
              status:
                file: Makefile
                target: generate_leaderboard_bundle_status
              get:
                file: Makefile
                target: generate_agent_bundle
              on_error:
                file: Makefile.runner
                target: launch_stop_workflow
          scenario:
            instance_id: "{{ item.spec.id }}"
            name: "{{ item.spec.name }}"
            type: SRE
            description: "{{ item.spec.name }}"
            category: "{{ (incident.truth.fault | map(attribute='category') | unique | list | last) | default('Other') }}"
            complexity: "{{ incident.spec.metadata.complexity }}"
            scenario_class: "{{ (incident.truth.fault | map(attribute='category') | unique | list | last) | default('Other') }}"
      loop: "{{ incidents }}"
      loop_control:
        label: incident-{{ item.spec.id }}
      tags:
        - always

    - name: Create bundle file
      ansible.builtin.copy:
        content: "{{ bundle_contents | to_nice_json }}"
        dest: scenarios.json
        mode: "0644"
      tags:
        - always
