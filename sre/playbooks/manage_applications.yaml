---
- name: Manage SRE and FinOps Incident Environment Sample Application Stack
  hosts:
    - environment
  pre_tasks:
    - name: Import system role
      ansible.builtin.import_role:
        name: system
      tags:
        - always
      vars:
        system_cluster:
          kubeconfig: "{{ cluster.kubeconfig }}"

    - name: Import variables for incident
      ansible.builtin.import_role:
        name: incidents
      tags:
        - always
      vars:
        incidents_file:
          id: "{{ incident_id }}"
      when:
        - incident_id is defined
  tasks:
    - name: Import applications role
      ansible.builtin.import_role:
        name: applications
      vars:
        applications_cluster:
          kubeconfig: "{{ cluster.kubeconfig }}"
        applications_required:
          otel_demo:
            configuration: "{{ incidents_applications.otel_demo.configuration | default({}) }}"
            enabled: "{{ incidents_applications.otel_demo.enabled | default(applications.otel_demo) }}"

    # - name: Import e2e role
    #   ansible.builtin.import_role:
    #     name: e2e
    #     tasks_from: register_deployment_time
    #   tags:
    #     - install_applications
    #   when:
    #     - incident.runner != 'local'

    # - name: Import e2e role
    #   ansible.builtin.import_role:
    #     name: e2e
    #     tasks_from: register_deployment_failure
    #   tags:
    #     - capture_failed_deployment_state
    #   when:
    #     - incident.runner != 'local'
