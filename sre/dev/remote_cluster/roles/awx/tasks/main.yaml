---
- name: Set variables
  ansible.builtin.set_fact:
    head_cluster_name: "{{ awx_stack.name_prefix }}-head-{{ awx_cluster.nodes.worker.instance_type }}-aws.k8s.local"
    runner_cluster_names: |
      {{
        [awx_stack.name_prefix + "-runner"] |
        product(range(1, awx_stack.runners.count + 1) | map('string')) |
        map('join', '-') |
        zip_longest([], fillvalue=awx_cluster.nodes.worker.instance_type + "-aws.k8s.local") |
        map('join', '-')
      }}
    state_store: s3://{{ awx_cluster.s3.bucket_name }}
  tags:
    - always

- name: Retrieve list of clusters
  ansible.builtin.command:
    argv:
      - kops
      - get
      - clusters
      - --output
      - json
      - --state
      - "{{ state_store }}"
  register: clusters_output
  changed_when: false
  ignore_errors: true
  tags:
    - always

- name: Parse cluster names
  ansible.builtin.set_fact:
    existing_cluster_names: |
      {{
        clusters_output.stdout |
        from_json |
        community.general.json_query('[*].metadata.name')
      }}
  tags:
    - always
  when:
    - clusters_output.rc == 0

- name: Import asynchronous AWX stack creation tasks
  ansible.builtin.import_tasks:
    file: create_async.yaml
  vars:
    cluster_names: |
      {{
        (runner_cluster_names + [head_cluster_name]) |
        difference(existing_cluster_names | default([]))
      }}
  tags:
    - create

- name: Import AWX installation tasks
  ansible.builtin.import_tasks:
    file: install_awx.yaml
  vars:
    cluster_name: "{{ head_cluster_name }}"
  tags:
    - create

- name: Import asynchronous AWX stack deletion tasks
  ansible.builtin.import_tasks:
    file: delete_async.yaml
  vars:
    cluster_names: |
      {{
        existing_cluster_names |
        default([]) |
        intersect((runner_cluster_names + [head_cluster_name]))
      }}
  tags:
    - delete
