---
- name: Check for kOps
  ansible.builtin.command:
    cmd: which kops
  register: system_kops_path
  changed_when: false

- name: Validate that kOps exists
  ansible.builtin.assert:
    that: system_kops_path.stdout_lines | length > 0
    fail_msg: kOps is not installed. Please install kops.
    success_msg: Using kOps at {{ system_kops_path.stdout_lines[0] }}

- name: Check kOps version
  ansible.builtin.command:
    cmd: "{{ system_kops_path.stdout_lines[0] }} version --short"
  register: raw_kops_version
  changed_when: false

- name: Parse kOps verion
  ansible.builtin.set_fact:
    system_kops_version: "{{ raw_kops_version.stdout }}"

- name: Validate the kOps version
  ansible.builtin.assert:
    that: "'1.31' is version_compare(system_kops_version, '<=')"
    fail_msg: "kOps version for system {{ system_kops_version }} must be at least 1.31 or later."
    success_msg: "kOps version {{ system_kops_version }} (>= 1.31) is OK."

- name: Gather all regions
  amazon.aws.aws_region_info:
  register: region_info

- name: Parse region names
  ansible.builtin.set_fact:
    regions: "{{ region_info.regions | community.general.json_query('[*].region_name') }}"

- name: Validate that region exists
  ansible.builtin.assert:
    that: kops_cluster.aws.region in regions
    fail_msg: "Invalid region. Please select from region: {{ regions }}"
    success_msg: AWS region validated.

- name: Gather available zones in the region
  amazon.aws.aws_az_info:
    region: "{{ kops_cluster.aws.region }}"
    filters:
      state: available
  register: availability_zone_info

- name: Parse zone names
  ansible.builtin.set_fact:
    available_zones: "{{ availability_zone_info.availability_zones | community.general.json_query('[*].zone_name') }}"

- name: Validate that zones are available
  ansible.builtin.assert:
    that: kops_cluster.aws.zones | difference(available_zones) | length == 0
    fail_msg: "At least one zone is not available. Please select from available zones: {{ available_zones }}"
    success_msg: All zones in region are available.
