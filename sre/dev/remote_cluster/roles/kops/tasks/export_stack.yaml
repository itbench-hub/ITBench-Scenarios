---
- name: Export kOps clusters' kubeconfig
  ansible.builtin.command:
    argv:
      - kops
      - export
      - --name
      - "{{ item }}"
      - kubecfg
      - --admin
      - --state
      - "{{ kops_state_store }}"
      - --kubeconfig
      - /tmp/{{ item }}.yaml
  register: kops_export_output
  changed_when: kops_export_output.rc == 0
  loop: "{{ stack_runner_names + [stack_head_name] }}"

- name: Update stack group variables file
  ansible.builtin.copy:
    content: "{{ stack_definition | to_nice_yaml(indent=2) }}"
    dest: "../../../group_vars/runner/stack.yaml"
    mode: "0644"
  vars:
    stack_definition:
      stack:
        awx:
          kubeconfig: /tmp/{{ stack_head_name }}.yaml
        runners:
          kubeconfigs: |
            {{
              [] |
              zip_longest(stack_runner_names, fillvalue="/tmp") |
              map('join', '/') |
              zip_longest([], fillvalue="yaml") |
              map('join', '.')
            }}

- name: Display the export environment variable command for the head cluster
  ansible.builtin.debug:
    msg:
      - "Run the following command to execute kubectl commands:"
      - export KUBECONFIG=/tmp/{{ stack_head_name }}.yaml
