---
- name: Import variable setting tasks
  ansible.builtin.import_tasks:
    file: set_awx_controller_host.yaml

- name: Import variable setting tasks
  ansible.builtin.import_tasks:
    file: set_awx_controller_password.yaml

- name: Create leaderboard workflow for starting incidents - Stage One
  awx.awx.workflow_job_template:
    ask_variables_on_launch: true
    controller_host: "{{ awx_controller_host }}"
    controller_password: "{{ awx_controller_password }}" # pragma: allowlist secret
    controller_username: admin
    inventory: ITBench
    name: "Start-Scenario-{{ incident }}"
    state: present
    workflow_nodes:
      - identifier: node-deploy-tools
        unified_job_template:
          name: "Scenario-{{ incident }}--Deploy-Tools"
          type: job_template
        related:
          success_nodes:
            - identifier: node-install-applications
          failure_nodes: []
          always_nodes: []
      - identifier: node-install-applications
        unified_job_template:
          name: "Scenario-{{ incident }}--Deploy-Applications"
          type: job_template
        related:
          success_nodes:
            - identifier: node-install-recorders
          failure_nodes: []
          always_nodes: []
      - identifier: node-install-recorders
        unified_job_template:
          name: "Scenario-{{ incident }}--Install-Data-Recorders"
          type: job_template
        related:
          success_nodes:
            - identifier: node-grant-access-to-agent
          failure_nodes: []
          always_nodes: []
      - identifier: node-grant-access-to-agent
        unified_job_template:
          name: "Scenario-{{ incident }}--Grant-Access-To-Agent"
          type: job_template
        related:
          success_nodes:
            - identifier: node-inject-fault
          failure_nodes: []
          always_nodes: []
      - identifier: node-inject-fault
        unified_job_template:
          name: "Scenario-{{ incident }}--Inject-Faults"
          type: job_template
        related:
          success_nodes:
            - identifier: node-handover-to-agent
          failure_nodes: []
          always_nodes: []
      # # TODO: Replace with a topology recorder run
      # - identifier: node-post-fault-injection
      #   unified_job_template:
      #     name: "Scenario-{{ incident }}--Post-Fault-Injection"
      #     type: job_template
      #   related:
      #     success_nodes:
      #       - identifier: node-check-for-alerts
      #     failure_nodes:
      #       - identifier: node-capture-failed-deployment
      #     always_nodes: []
      # - identifier: node-check-for-alerts
      #   unified_job_template:
      #     name: "Scenario-{{ incident }}--Check-for-Alerts"
      #     type: job_template
      #   related:
      #     success_nodes: [] # - identifier: node-handover-to-agent
      #     failure_nodes: []
      #     always_nodes: []
      - identifier: node-handover-to-agent
        unified_job_template:
          name: "Scenario-{{ incident }}--Handover-To-Agent"
          type: job_template
        related:
          success_nodes: []
          failure_nodes: []
          always_nodes: []

# Evaluation - Stage Two

- name: Create workflow for stopping incidents - Stage Three
  awx.awx.workflow_job_template:
    ask_variables_on_launch: true
    controller_host: "{{ awx_controller_host }}"
    controller_password: "{{ awx_controller_password }}" # pragma: allowlist secret
    controller_username: admin
    name: "Stop-Scenario-{{ incident }}"
    inventory: ITBench
    state: present
    workflow_nodes:
      # # Currently handled at Stage 2 -- Evaluation
      # - identifier: node-handback-from-agent
      #   unified_job_template:
      #     name: "Scenario-{{ incident }}--Handback-From-Agent"
      #     type: job_template
      #   related:
      #     success_nodes: []
      #     failure_nodes: []
      #     always_nodes:
      #       - identifier: node-remove-access-from-agent
      - identifier: node-remove-access-from-agent
        unified_job_template:
          name: "Scenario-{{ incident }}--Remove-Access-From-Agent"
          type: job_template
        related:
          success_nodes: []
          failure_nodes: []
          always_nodes:
            - identifier: node-uninstall-recorders
      - identifier: node-uninstall-recorders
        unified_job_template:
          name: "Scenario-{{ incident }}--Uninstall-Data-Recorders"
          type: job_template
        related:
          success_nodes: []
          failure_nodes: []
          always_nodes:
            - identifier: node-remove-fault
      - identifier: node-remove-fault
        unified_job_template:
          name: "Scenario-{{ incident }}--Remove-Faults"
          type: job_template
        related:
          success_nodes: []
          failure_nodes: []
          always_nodes:
            - identifier: node-undeploy-applications
      - identifier: node-undeploy-applications
        unified_job_template:
          name: "Scenario-{{ incident }}--Undeploy-Applications"
          type: job_template
        related:
          success_nodes: []
          failure_nodes: []
          always_nodes:
            - identifier: node-undeploy-tools
      - identifier: node-undeploy-tools
        unified_job_template:
          name: "Scenario-{{ incident }}--Undeploy-Tools"
          type: job_template
        related:
          success_nodes: []
          failure_nodes: []
          always_nodes: []
