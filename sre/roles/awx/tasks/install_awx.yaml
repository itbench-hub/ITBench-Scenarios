---
- name: Install AWX operator
  kubernetes.core.helm:
    chart_ref: awx-operator
    chart_repo_url: https://ansible-community.github.io/awx-operator-helm
    chart_version: 3.2.0
    create_namespace: true
    kubeconfig: "{{ awx_cluster.kubeconfig }}"
    release_name: "{{ awx_helm_releases.awx_operator.name }}"
    release_namespace: "{{ awx_helm_releases.awx_operator.namespace }}"
    release_state: present
    timeout: 10m0s
    wait: true

- name: Create experiment data PersistentVolume
  kubernetes.core.k8s:
    kubeconfig: "{{ awx_cluster.kubeconfig }}"
    resource_definition:
      apiVersion: v1
      kind: PersistentVolume
      metadata:
        name: experiment-data-pv
      spec:
        capacity:
          storage: 1Gi
        accessModes:
          - ReadWriteMany
        hostPath:
          path: /mnt/experiment-data
          type: DirectoryOrCreate
        persistentVolumeReclaimPolicy: Retain
    state: present
  when:
    - awx_cluster.cloud_provider == "kind"

- name: Create experiment data PersistentVolumeClaim
  kubernetes.core.k8s:
    kubeconfig: "{{ awx_cluster.kubeconfig }}"
    resource_definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: experiment-data-pvc
        namespace: "{{ awx_helm_releases.awx_operator.namespace }}"
      spec:
        accessModes:
          - ReadWriteMany
        resources:
          requests:
            storage: 1Gi
        volumeName: experiment-data-pv
        storageClassName: ""
    state: present
  when:
    - awx_cluster.cloud_provider == "kind"

- name: Install AWX
  kubernetes.core.k8s:
    kubeconfig: "{{ awx_cluster.kubeconfig }}"
    resource_definition:
      apiVersion: awx.ansible.com/v1beta1
      kind: AWX
      metadata:
        name: awx-deployment
        namespace: "{{ awx_helm_releases.awx_operator.namespace }}"
      spec: "{{ awx_base_spec | combine(awx_nodeport_spec if awx_cluster.cloud_provider == 'kind' | default(false) else {}) | combine(awx_volume_spec if awx_cluster.cloud_provider
        == 'kind' | default(false) else {}) }}"
    state: present
    wait: "{{ awx_cluster.cloud_provider != 'kind' }}"
    wait_condition:
      reason: Successful
      status: "True"
      type: Successful
    wait_timeout: 900
  vars:
    awx_base_spec:
      service_type: "{{ 'nodeport' if awx_cluster.cloud_provider == 'kind' | default(false) else 'loadbalancer' }}"
      postgres_data_volume_init: true
      postgres_init_container_commands: |
        chown 26:0 /var/lib/pgsql/data
        chmod 700 /var/lib/pgsql/data
      postgres_storage_requirements:
        requests:
          storage: "{{ '4Gi' if awx_cluster.cloud_provider == 'kind' | default(false) else '32Gi' }}"
    awx_nodeport_spec:
      nodeport_port: 30950
    awx_volume_spec:
      extra_volumes: |
        - name: experiment-data
          persistentVolumeClaim:
            claimName: experiment-data-pvc
      ee_extra_volume_mounts: |
        - name: experiment-data
          mountPath: /mnt/experiment-data
      task_extra_volume_mounts: |
        - name: experiment-data
          mountPath: /mnt/experiment-data
      init_container_extra_volume_mounts: |
        - name: experiment-data
          mountPath: /mnt/experiment-data
      init_container_extra_commands: |
        mkdir -p /mnt/experiment-data
        chown -R 1000:0 /mnt/experiment-data
        chmod -R 755 /mnt/experiment-data
        chmod g+s /mnt/experiment-data

- name: Handle certificate signing requests on Kind
  when:
    - awx_cluster.cloud_provider == 'kind'
  block:
    - name: Wait for AWX pods to be created
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        kubeconfig: "{{ awx_cluster.kubeconfig }}"
        namespace: "{{ awx_helm_releases.awx_operator.namespace }}"
        label_selectors:
          - "app.kubernetes.io/managed-by=awx-operator"
      register: awx_pods
      until: awx_pods.resources | length > 0
      retries: 30
      delay: 10

    - name: Include tasks to approve pending certificate requests
      ansible.builtin.include_role:
        name: cluster
        tasks_from: approve_certificate_requests
      vars:
        cluster_files:
          kubeconfig: "{{ awx_cluster.kubeconfig }}"
    - name: Wait for AWX to be ready
      kubernetes.core.k8s_info:
        api_version: awx.ansible.com/v1beta1
        kind: AWX
        kubeconfig: "{{ awx_cluster.kubeconfig }}"
        name: awx-deployment
        namespace: "{{ awx_helm_releases.awx_operator.namespace }}"
      register: awx_status
      until:
        - awx_status.resources is defined
        - awx_status.resources | length > 0
        - awx_status.resources[0].status.conditions is defined
        - awx_status.resources[0].status.conditions | selectattr('type', 'equalto', 'Successful') | selectattr('status', 'equalto', 'True') | list | length > 0
      retries: 90
      delay: 10
