---
- name: Retrieve information on workload
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: "{{ spec.workload.kind }}"
    name: "{{ spec.workload.name }}"
    namespace: "{{ spec.workload.namespace }}"
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
  register: faults_workload_info

- name: Environment variables to add or update
  set_fact:
    env_vars_to_update: "{{ spec.workload.env | default([]) }}"

- name: Find target container index
  set_fact:
    target_container_index: >-
      {{
        (faults_workload_info.resources[0].spec.template.spec.containers |
         map(attribute='name') | list).index(spec.workload.container_name)
      }}
  when: spec.workload.container_name is defined

- name: Use first container if no container name specified
  set_fact:
    target_container_index: 0
  when: spec.workload.container_name is not defined

- name: Get current environment variables for target container
  set_fact:
    current_env: >-
      {{
        faults_workload_info.resources[0].spec.template.spec.containers[target_container_index | int].env | default([])
      }}

- name: Create final environment variables list
  set_fact:
    final_env: >-
      {{
        (current_env | rejectattr('name', 'in', env_vars_to_update | map(attribute='name') | list) | list) +
        env_vars_to_update
      }}

- name: Apply updated environment variables
  kubernetes.core.k8s_json_patch:
    api_version: apps/v1
    kind: "{{ spec.workload.kind }}"
    name: "{{ spec.workload.name }}"
    namespace: "{{ spec.workload.namespace }}"
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
    patch:
      - op: replace
        path: "/spec/template/spec/containers/{{ target_container_index }}/env"
        value: "{{ final_env }}"
