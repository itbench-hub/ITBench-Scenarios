---
- name: Get current replica count before scaling down
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: "{{ spec.workload.kind }}"
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
    name: "{{ spec.workload.name }}"
    namespace: "{{ spec.workload.namespace }}"
    replicas: 0
    wait: true

- name: Get original replica count
  include_tasks: ../utils/get_replica_count.yaml

- name: Scale down workload
  include_tasks: ../utils/scale_down_workload.yaml

- name: Inject fault (invalid command)
  kubernetes.core.k8s_json_patch:
    api_version: apps/v1
    kind: "{{ spec.workload.kind }}"
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
    name: "{{ spec.workload.name }}"
    namespace: "{{ spec.workload.namespace }}"
    patch:
      - op: replace
        path: /spec/template/spec/containers/0/command
        value: ["invalid-command"]

- name: Scale up workload after fault injection
  kubernetes.core.k8s_scale:
    api_version: apps/v1
    kind: "{{ spec.workload.kind }}"
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
    name: "{{ spec.workload.name }}"
    namespace: "{{ spec.workload.namespace }}"
    replicas: 1
    wait: false
