- name: Retrieve information on valkey workload
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: "{{ spec.workload.kind }}"
    name: "{{ spec.workload.name }}"
    namespace: "{{ spec.workload.namespace }}"
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
  register: faults_workload_info

- name: Set storage size to fill (container filesystem)
  ansible.builtin.set_fact:
    storage_size_mb: 500
  when:
    - faults_workload_info.resources | length > 0

- name: Add storage filler sidecar container to deployment
  kubernetes.core.k8s_json_patch:
    api_version: apps/v1
    kind: "{{ spec.workload.kind }}"
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
    name: "{{ spec.workload.name }}"
    namespace: "{{ spec.workload.namespace }}"
    patch:
      - op: add
        path: /spec/template/spec/containers/-
        value:
          name: storage-filler
          image: busybox:latest
          command:
            - /bin/sh
            - -c
            - dd if=/dev/zero of=/tmp/filler bs=1M count={{ storage_size_mb }} && sleep infinity
  when:
    - storage_size_mb is defined
