---
- name: Retrieve services from cluster
  kubernetes.core.k8s_info:
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
    api_version: v1
    kind: Service
    name: "{{ item.name }}"
    namespace: "{{ item.namespace }}"
  register: services_info
  loop: "{{ fault.services }}"
  loop_control:
    label: service/{{ item.name }}

- name: Create list of indicies of target port in service definition
  ansible.builtin.set_fact:
    indexes: |
      {{
        (indexes | default([])) +
        [(item[1],  lookup('ansible.utils.index_of', item[0].resources[0].spec.ports, 'eq', 9999, 'targetPort')]
      }}
  loop: "{{ services_info.results | zip(fault.services) | list }}"
  loop_control:
    label: service/{{ item.[1]name }}
  when:
    - item[0].resources | length > 0

- name: Inject fault (misconfigured service port)
  kubernetes.core.k8s_json_patch:
    api_version: v1
    kind: Service
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
    name: "{{ item[0].name }}"
    namespace: "{{ item[0].namespace }}"
    patch:
      - op: replace
        path: /spec/ports/{{ item[1] }}/targetPort
        value: "{{ item[0].targetPort }}"
  loop: "{{ indexes }}"
  loop_control:
    label: service/{{ item[0].name }}
