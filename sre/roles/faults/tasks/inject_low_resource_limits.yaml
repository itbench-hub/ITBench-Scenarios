---
- name: Retrieve workload information for target services
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: "{{ workload.kind }}"
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
    name: "{{ workload.name }}"
    namespace: "{{ spec.namespace.name }}"
  register: faults_workloads_info
  loop: "{{ spec.workloads }}"
  loop_control:
    label: "{{ workload.kind | lower }}/{{ workload.name }}"
    loop_var: workload
  when:
    - workload.name in ['valkey', 'postgresql']  # Only target specific services

- name: Patch workloads with restrictive resource limits
  kubernetes.core.k8s:
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
    state: patched
    api_version: "{{ result.resources[0].apiVersion }}"
    kind: "{{ result.resources[0].kind }}"
    name: "{{ result.resources[0].metadata.name }}"
    namespace: "{{ result.resources[0].metadata.namespace }}"
    definition:
      spec:
        template:
          spec:
            containers:
            - name: "{{ result.resources[0].spec.template.spec.containers[0].name }}"
              resources:
                limits:
                  memory: "256Mi" 
                  cpu: "200m"
                requests:
                  memory: "128Mi"
                  cpu: "100m"
  loop: "{{ faults_workloads_info.results }}"
  loop_control:
    label: "{{ result.resources[0].kind | lower }}/{{ result.resources[0].metadata.name }}"
    loop_var: result
  when:
    - faults_workloads_info is defined
    - result.resources | length == 1

- name: Restart workloads to apply new resource limits
  kubernetes.core.k8s:
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
    state: patched
    api_version: "{{ result.resources[0].apiVersion }}"
    kind: "{{ result.resources[0].kind }}"
    name: "{{ result.resources[0].metadata.name }}"
    namespace: "{{ result.resources[0].metadata.namespace }}"
    definition:
      spec:
        template:
          metadata:
            annotations:
              kubectl.kubernetes.io/restartedAt: "{{ ansible_date_time.iso8601 }}"
  loop: "{{ faults_workloads_info.results }}"
  loop_control:
    label: "{{ result.resources[0].kind | lower }}/{{ result.resources[0].metadata.name }}"
    loop_var: result
  when:
    - faults_workloads_info is defined
    - result.resources | length == 1