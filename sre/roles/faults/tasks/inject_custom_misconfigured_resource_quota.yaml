---
- name: Create ResourceQuota with hard memory limits
  kubernetes.core.k8s:
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
    resource_definition:
      apiVersion: v1
      kind: ResourceQuota
      metadata:
        name: "{{ namespace.name }}-resource-quota"
        namespace: "{{ namespace.name }}"
      spec:
        hard:
          memory: 2Gi
    state: present
  loop: "{{ targets.namespaces }}"
  loop_control:
    label: "namespace/{{ namespace.name }}"
    loop_var: namespace

- name: Retrieve replica information from workload managers
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: "{{ manager.kind }}"
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
    name: "{{ manager.name }}"
    namespace: "{{ manager.namespace }}"
  register: faults_workload_managers_info
  loop: "{{ targets.workload_managers }}"
  loop_control:
    label: "{{ manager.kind | lower }}/{{ manager.name }}"
    loop_var: manager
  when:
    - manager.name != 'otel-collector'

- name: Scale down workloads to 0 replicas
  kubernetes.core.k8s_scale:
    api_version: "{{ result.resources[0].apiVersion }}"
    kind: "{{ result.resources[0].kind }}"
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
    name: "{{ result.resources[0].metadata.name }}"
    namespace: "{{ result.resources[0].metadata.namespace }}"
    replicas: 0
    wait: true
    wait_timeout: 60
  loop: "{{ faults_workload_managers_info.results }}"
  loop_control:
    label: "{{ result.resources[0].kind | lower }}/{{ result.resources[0].metadata.name }}"
    loop_var: result
  when:
    - result.resources | length == 1

- name: Scale up workloads to original replica count
  kubernetes.core.k8s_scale:
    api_version: "{{ result.resources[0].apiVersion }}"
    kind: "{{ result.resources[0].kind }}"
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
    name: "{{ result.resources[0].metadata.name }}"
    namespace: "{{ result.resources[0].metadata.namespace }}"
    replicas: "{{ result.resources[0].spec.replicas }}"
    wait: false
  loop: "{{ faults_workload_managers_info.results }}"
  loop_control:
    label: "{{ result.resources[0].kind | lower }}/{{ result.resources[0].metadata.name }}"
    loop_var: result
  when:
    - result.resources | length == 1
