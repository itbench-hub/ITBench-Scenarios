---
- name: Create ResourceQuota with hard memory limits
  kubernetes.core.k8s:
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
    resource_definition:
      apiVersion: v1
      kind: ResourceQuota
      metadata:
        name: "{{ namespace.name }}-resource-quota"
        namespace: "{{ namespace.name }}"
      spec:
        hard:
          memory: 1Gi
    state: present
  loop: "{{ targets }}"
  loop_control:
    label: "namespace/{{ namespace.name }}"
    loop_var: namespace

- name: Restart all deployments to trigger new pod creations
  ansible.builtin.command:
    cmd: kubectl -n {{ namespace.name }} rollout restart deployment
  environment:
    KUBECONFIG: "{{ faults_cluster.kubeconfig | ansible.builtin.expanduser }}"
  register: rollout_restart_output
  changed_when: rollout_restart_output.rc == 0
  loop: "{{ targets }}"
  loop_control:
    label: "namespace/{{ namespace.name }}"
    loop_var: namespace
