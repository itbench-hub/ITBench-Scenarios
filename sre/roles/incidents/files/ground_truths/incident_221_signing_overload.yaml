---
# Ground Truth for Incident 52: Service Resource Exhaustion Due to Queue Backlog
# Based on ITN-2025-00221 incident pattern - adapted for ITBench otel-demo application
metadata:
  version: "v1"

fault:
  - entity:
      name: kafka
      group_id: kafka-pod-1
      kind: Pod
    condition: "Kafka queue experiencing backlog due to consumer processing delay"
    category: Resource Exhaustion
    fault_mechanism: custom(flagd)
    note: "kafkaQueueProblems feature flag enabled causing queue backlog"

  - entity:
      name: accounting-service
      group_id: accounting-pod-1
      kind: Pod
    condition: "Service unable to process messages fast enough, causing queue buildup"
    category: Configuration Error
    fault_mechanism: custom(flagd)

  - entity:
      name: fraud-detection-service
      group_id: fraud-detection-pod-1
      kind: Pod
    condition: "Service experiencing high latency processing queued messages"
    category: Resource Saturation
    fault_mechanism: chaos-mesh-StressChaos

  - entity:
      name: flagd-config
      group_id: flagd-config-1
      kind: ConfigMap
    condition: "kafkaQueueProblems feature flag set causing consumer delay"
    category: Configuration Setting
    fault_mechanism: custom(flagd)

alerts:
  # Using existing ITBench alerts from otel-demo.yaml
  - id: RequestErrorRate
    group_id: accounting-service-1
    metadata:
      description: "Request error rate in accounting service is above threshold due to queue backlog"
      severity: warning

  - id: RequestErrorRate
    group_id: fraud-detection-service-1
    metadata:
      description: "Request error rate in fraud-detection service is above threshold"
      severity: warning

  - id: RequestLatencyProcessor
    group_id: accounting-service-1
    metadata:
      description: "P95 latency in accounting service exceeds 15000ms threshold"
      severity: warning

  - id: RequestLatencyProcessor
    group_id: fraud-detection-service-1
    metadata:
      description: "P95 latency in fraud-detection service exceeds 15000ms threshold"
      severity: warning

  - id: KafkaConnectionClosureRate
    group_id: kafka-pod-1
    metadata:
      description: "Kafka consumer connection closure rate above 0 indicating consumer issues"
      severity: warning

  - id: NoRequestsDetected
    group_id: checkout-service-1
    metadata:
      description: "Checkout service has 0 requests due to upstream service failures"
      severity: warning

  - id: PendingPodsDetected
    group_id: accounting-pod-1
    metadata:
      description: "Pods stuck in Pending state if attempting to scale under resource constraints"
      severity: critical

groups:
  - id: flagd-config-1
    kind: ConfigMap
    namespace: otel-demo
    filter:
      - flagd-config\b
    root_cause: true
    reason: "kafkaQueueProblems feature flag enabled causing queue backlog and consumer delay"

  - id: flagd-pod-1
    kind: Pod
    namespace: otel-demo
    filter:
      - flagd-.*

  - id: flagd-service-1
    kind: Service
    namespace: otel-demo
    filter:
      - flagd\b

  - id: kafka-pod-1
    kind: Pod
    namespace: otel-demo
    filter:
      - kafka-.*

  - id: kafka-service-1
    kind: Service
    namespace: otel-demo
    filter:
      - kafka\b

  - id: accounting-pod-1
    kind: Pod
    namespace: otel-demo
    filter:
      - accountingservice-.*

  - id: accounting-service-1
    kind: Service
    namespace: otel-demo
    filter:
      - accountingservice\b

  - id: fraud-detection-pod-1
    kind: Pod
    namespace: otel-demo
    filter:
      - frauddetectionservice-.*

  - id: fraud-detection-service-1
    kind: Service
    namespace: otel-demo
    filter:
      - frauddetectionservice\b

  - id: checkout-pod-1
    kind: Pod
    namespace: otel-demo
    filter:
      - checkoutservice-.*

  - id: checkout-service-1
    kind: Service
    namespace: otel-demo
    filter:
      - checkoutservice\b

aliases:
  - - flagd-pod-1
    - flagd-service-1
  - - kafka-pod-1
    - kafka-service-1
  - - accounting-pod-1
    - accounting-service-1
  - - fraud-detection-pod-1
    - fraud-detection-service-1
  - - checkout-pod-1
    - checkout-service-1

propagations:
  # Feature flag enables queue problems
  - source: flagd-config-1
    target: flagd-service-1
    condition: "kafkaQueueProblems feature flag set to 'on'"
    effect: "Flagd enables Kafka queue overload and consumer delay injection"

  # Kafka queue backlog builds
  - source: flagd-service-1
    target: kafka-service-1
    condition: "Kafka queue overloaded with messages"
    effect: "Message queue depth increases, consumer lag grows"

  # Accounting service affected by queue backlog
  - source: kafka-service-1
    target: accounting-service-1
    condition: "Consumer delay causes slow message processing"
    effect: "Accounting service latency increases dramatically, errors occur"

  # Fraud detection service affected
  - source: kafka-service-1
    target: fraud-detection-service-1
    condition: "Consumer cannot process messages fast enough"
    effect: "Fraud detection service latency exceeds threshold"

  # Cascading failure to checkout
  - source: accounting-service-1
    target: checkout-service-1
    condition: "Accounting service unavailable or timing out"
    effect: "Checkout service cannot complete orders, receives no successful requests"

  - source: fraud-detection-service-1
    target: checkout-service-1
    condition: "Fraud detection service unavailable or timing out"
    effect: "Checkout blocked waiting for fraud check response"

recommended_actions:
  - solution:
      id: disable_kafka_queue_problems_flag
      actions:
        - "Disable kafkaQueueProblems feature flag in flagd-config ConfigMap"
        - "Set defaultVariant to 'off' for kafkaQueueProblems"
      timing: "Immediate"

  - solution:
      id: monitor_kafka_consumer_lag
      actions:
        - "Check Kafka consumer lag metrics"
        - "Verify consumer group health"
      timing: "During investigation"

  - solution:
      id: scale_consumer_services
      actions:
        - "Scale accounting and fraud-detection deployments"
        - "Increase consumer processing capacity"
      timing: "If load is legitimate"

  - solution:
      id: improve_queue_monitoring
      actions:
        - "Add alerting on Kafka consumer lag trending"
        - "Dashboard for message processing rate vs incoming rate"
      timing: "Post-incident improvement"

