---
- name: Debug - Starting clickhouse credentials setup
  ansible.builtin.debug:
    msg: "Starting to set clickhouse credentials"

- name: Debug namespace and secret details
  ansible.builtin.debug:
    msg:
      - "Looking for secret: user-default-credentials"
      - "In namespace: {{ tools_instances.clickhouse.namespace }}"
      - "Using kubeconfig: {{ tools_cluster.kubeconfig }}"

- name: List all secrets in the namespace
  kubernetes.core.k8s_info:
    kind: Secret
    kubeconfig: "{{ tools_cluster.kubeconfig }}"
    namespace: "{{ tools_instances.clickhouse.namespace }}"
  register: all_secrets

- name: Show all secrets in namespace
  ansible.builtin.debug:
    msg: "Available secrets: {{ all_secrets.resources | map(attribute='metadata.name') | list }}"

- name: Retrieve secret containing Clickhouse default user credentials
  kubernetes.core.k8s_info:
    kind: Secret
    kubeconfig: "{{ tools_cluster.kubeconfig }}"
    name: user-default-credentials
    namespace: "{{ tools_instances.clickhouse.namespace }}"
    wait: true
  register: tools_clickhouse_user_secret_info

- name: Extract Clickhouse credentials
  ansible.builtin.set_fact:
    tools_clickhouse_username: "{{ tools_clickhouse_user_secret_info.resources[0].data.user | b64decode }}"
    tools_clickhouse_password: "{{ tools_clickhouse_user_secret_info.resources[0].data.password | b64decode }}"
  when:
    - tools_clickhouse_user_secret_info.resources | length > 0
