---
apiVersion: v1
kind: Secret
metadata:
  name: user-default-credentials
  namespace: {{ tools_instances.clickhouse.namespace }}
type: Opaque
stringData:
  user: default
  password: ""
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: clickhouse-init-prometheus
  labels:
    app.kubernetes.io/name: clickhouse
data:
  01_init_prometheus.sql: |
    -- Based on https://clickhouse.com/docs/engines/table-engines/special/time_series
    -- Create database for Prometheus metrics
    CREATE DATABASE IF NOT EXISTS prometheus;
    
    -- Create the TimeSeries table with default schema
    CREATE TABLE IF NOT EXISTS prometheus.metrics
    ENGINE = TimeSeries;
---
apiVersion: clickhouse.altinity.com/v1
kind: ClickHouseInstallationTemplate
metadata:
  name: clickhouse-pod
  namespace: {{ tools_instances.clickhouse.namespace }}
  labels:
    app.kubernetes.io/name: clickhouse
    app.kubernetes.io/version: 25.3.8.10041
spec:
  templates:
    podTemplates:
      - name: clickhouse-pod
        metadata:
          annotations:
            openshift.io/required-scc: restricted-v2
          labels:
            app.kubernetes.io/name: clickhouse
            app.kubernetes.io/version: 25.3.8.10041
        spec:
          securityContext:
            fsGroup: 101
            runAsGroup: 101
            runAsNonRoot: true
            runAsUser: 101
            seccompProfile:
              type: "RuntimeDefault"
          containers:
            - name: clickhouse
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
              image: docker.io/altinity/clickhouse-server:25.3.8.10041.altinitystable
              imagePullPolicy: IfNotPresent
              ports:
                - name: http
                  containerPort: 8123
                - name: tcp
                  containerPort: 9000
                - name: prometheus
                  containerPort: 9363
              resources:
                requests:
                  cpu: 100m
                  memory: 2Gi
                limits:
                  memory: 6Gi
              volumeMounts:
                - name: initdb-volume
                  mountPath: /docker-entrypoint-initdb.d
                  readOnly: true
          volumes:
            - name: initdb-volume
              configMap:
                name: clickhouse-init-prometheus
                defaultMode: 0555
---
apiVersion: clickhouse.altinity.com/v1
kind: ClickHouseInstallationTemplate
metadata:
  name: clickhouse-data
  namespace: {{ tools_instances.clickhouse.namespace }}
  labels:
    app.kubernetes.io/name: clickhouse
    app.kubernetes.io/version: 25.3.8.10041
spec:
  templates:
    volumeClaimTemplates:
      - name: clickhouse-data
        reclaimPolicy: Retain
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 15Gi
---
apiVersion: clickhouse.altinity.com/v1
kind: ClickHouseInstallationTemplate
metadata:
  name: clickhouse-service
  namespace: {{ tools_instances.clickhouse.namespace }}
  labels:
    app.kubernetes.io/name: clickhouse
    app.kubernetes.io/version: 25.3.8.10041
spec:
  templates:
    serviceTemplates:
      - name: clickhouse-service
        metadata:
          labels:
            app.kubernetes.io/name: clickhouse
            app.kubernetes.io/version: 25.3.8.10041
        spec:
          type: ClusterIP
          ports:
            - name: http
              port: 8123
              targetPort: 8123
            - name: tcp
              port: 9000
              targetPort: 9000
            - name: prometheus
              port: 9363
              targetPort: 9363
          selector:
            app.kubernetes.io/name: clickhouse
---
apiVersion: clickhouse.altinity.com/v1
kind: ClickHouseInstallation
metadata:
  name: {{ tools_instances.clickhouse.names.main }}
  namespace: {{ tools_instances.clickhouse.namespace }}
  labels:
    app.kubernetes.io/name: clickhouse
    app.kubernetes.io/version: 25.3.8.10041
spec:
  defaults:
    templates:
      dataVolumeClaimTemplate: clickhouse-data
      podTemplate: clickhouse-pod
      serviceTemplate: clickhouse-service
  useTemplates:
    - name: clickhouse-data
    - name: clickhouse-pod
    - name: clickhouse-service
  configuration:
    users:
      default/networks/ip: 0.0.0.0/0
      default/access_management: 1
      default/named_collection_control: 1
      default/show_named_collections: 1
      default/show_named_collections_secrets: 1
      default/password:
        valueFrom:
          secretKeyRef:
            name: user-default-credentials
            key: password
    clusters:
      - name: main
        layout:
          shardsCount: 1
          replicasCount: 1
