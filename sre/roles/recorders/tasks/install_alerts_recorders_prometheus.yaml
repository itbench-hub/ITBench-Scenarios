---
- name: Import tools role for variable setting tasks
  ansible.builtin.import_role:
    name: tools
    tasks_from: set_prometheus_endpoint
  vars:
    tools_cluster:
      kubeconfig: "{{ recorders_cluster.kubeconfig }}"
      platform: "{{ recorders_cluster.platform }}"

- name: Create Secret with Prometheus bearer token
  kubernetes.core.k8s:
    kubeconfig: "{{ recorders_cluster.kubeconfig }}"
    resource_definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: alerts-recorder-prometheus-token
        namespace: "{{ recorders_namespace.name }}"
      data:
        token: "{{ tools_prometheus_bearer_token }}"
    state: present
  when:
    - recorders_cluster.platform == "openshift"
    - tools_prometheus_bearer_token is defined

- name: Create ConfigMap with Python script
  kubernetes.core.k8s:
    kubeconfig: "{{ recorders_cluster.kubeconfig }}"
    resource_definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: alerts-recorder-prometheus-scripts
        namespace: "{{ recorders_namespace.name }}"
      data:
        deps: "{{ lookup('ansible.builtin.file', 'files/alerts/prometheus/scripts/requirements.txt') }}"
        script: "{{ lookup('ansible.builtin.file', 'files/alerts/prometheus/scripts/gather.py') }}"
    state: present

- name: Install Prometheus Alert Recorder
  kubernetes.core.k8s:
    kubeconfig: "{{ recorders_cluster.kubeconfig }}"
    namespace: "{{ recorders_namespace.name }}"
    src: files/alerts/prometheus/statefulset.yaml
    state: present

- name: Create Prometheus Alert Recorder environment list
  ansible.builtin.set_fact:
    recorders_prometheus_env_vars:
      - name: PROMETHEUS_ENDPOINT
        value: "{{ tools_prometheus_endpoint }}"
  when:
    - tools_prometheus_endpoint is defined

- name: Add Secret to environment list
  ansible.builtin.set_fact:
    recorders_prometheus_env_vars: |
      {{
        recorders_prometheus_env_vars +
        [{
          'name': PROMETHEUS_TOKEN,
          'valueFrom': {
            'secretKeyRef': {
              'name': 'alerts-recorder-prometheus-token',
              'key': 'token'
            }
          }
        }]
      }}
  when:
    - recorders_cluster.platform == "openshift"
    - tools_prometheus_bearer_token is defined
    - recorders_prometheus_env_vars is defined

- name: Update Prometheus Alert Recorder environment variables
  kubernetes.core.k8s:
    kubeconfig: "{{ recorders_cluster.kubeconfig }}"
    resource_definition:
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: prometheus-alert-recorder
        namespace: "{{ recorders_namespace.name }}"
      spec:
        template:
          spec:
            containers:
              - name: recorder
                env: "{{ recorders_prometheus_env_vars }}"
    state: patched
  when:
    - recorders_prometheus_env_vars is defined

- name: Wait for workload to update
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: StatefulSet
    kubeconfig: "{{ recorders_cluster.kubeconfig }}"
    name: prometheus-alert-recorder
    namespace: "{{ recorders_namespace.name }}"
  register: recorders_statefulset_info
  until:
    - recorders_statefulset_info.resources | length > 0
    - recorders_statefulset_info.resources[0].status is defined
    - recorders_statefulset_info.resources[0].status.readyReplicas is defined
    - recorders_statefulset_info.resources[0].status.readyReplicas == 1
  retries: 8
  delay: 15
