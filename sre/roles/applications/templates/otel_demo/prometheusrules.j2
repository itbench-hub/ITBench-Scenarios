---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: otel-demo-alerting-rules
  namespace: [[ applications_helm_releases.otel_demo.namespace ]]
spec:
  groups:
    - name: opentelemetrydemo.workloads
      rules:
        - alert: FailedPodsDetected
          expr: |
            sum by (namespace) (
              kube_pod_status_phase{
                namespace="[[ applications_helm_releases.otel_demo.namespace ]]",
                phase="Failed"
              }
            ) > 0
          for: 2m
          labels:
            severity: critical
          annotations:
            description: "Pods in failed state in namespace {{ $labels.namespace }} is above 0 (current: {{ $value }})"
    - name: opentelemetrydemo.frontend.goldensignal
      rules:
        - alert: HighRequestLatency
          expr: |
            histogram_quantile(
              0.95,
              sum (
                rate(
                  traces_span_metrics_duration_milliseconds_bucket{
                    service_name=~"frontend|frontend-proxy",
                    namespace="[[ applications_helm_releases.otel_demo.namespace ]]"
                  }[2m]
                )
              ) by(le, service_name, namespace)
            )
            > 1500
          for: 1m
          labels:
            severity: critical
          annotations:
            description: "Latency in service {{ $labels.service_name }} in namespace {{ $labels.namespace }} is above 1500ms (current: {{ $value }}s)"
        - alert: HighRequestErrorRate
          expr: |
            sum (
              rate(
                traces_span_metrics_calls_total{
                  service_name=~"frontend|frontend-proxy",
                  status_code="STATUS_CODE_ERROR",
                  namespace="[[ applications_helm_releases.otel_demo.namespace ]]"
                }[2m]
              )
            ) by (service_name, namespace)
            > 0
          for: 1m
          labels:
            severity: critical
          annotations:
            description: "Request error rate in service {{ $labels.service_name }} in namespace {{ $labels.namespace }} is above 3 (current: {{ $value }})"
    - name: opentelemetrydemo.backend.goldensignal
      rules:
        - alert: HighRequestLatency
          expr: |
            histogram_quantile(
              0.95,
              sum (
                rate(
                  traces_span_metrics_duration_milliseconds_bucket{
                    service_name!~"flagd|load-generator|frontend*",
                    namespace="[[ applications_helm_releases.otel_demo.namespace ]]"
                  }[2m]
                )
              ) by(le, service_name, namespace)
            )
            > 1500
          for: 1m
          labels:
            severity: critical
          annotations:
            description: "Latency in service {{ $labels.service_name }} in namespace {{ $labels.namespace }} is above 15000ms (current: {{ $value }}s)"
        - alert: HighRequestErrorRate
          expr: |
            sum (
              rate(
                traces_span_metrics_calls_total{
                  service_name!~"flagd|load-generator|frontend|frontend-proxy",
                  status_code="STATUS_CODE_ERROR",
                  namespace="[[ applications_helm_releases.otel_demo.namespace ]]"
                }[2m]
              )
            ) by (service_name, namespace)
            > 0
          for: 1m
          labels:
            severity: critical
          annotations:
            description: "Request error rate in service {{ $labels.service_name }} in namespace {{ $labels.namespace }} is above 1 (current: {{ $value }})"
        - alert: HighKafkaConnectionClosureRate
          expr: |
            sum by (job) (
              rate(
                kafka_consumer_connection_close_rate{
                  namespace="[[ applications_helm_releases.otel_demo.namespace ]]"
                }[2m]
              )
            ) > 0
          for: 1m
          labels:
            severity: warning
          annotations:
            description: "Job {{ $labels.job }} has a closure rate above 0 (current: {{ $value }})"
    - name: opentelemetrydemo.requests
      rules:
        - alert: NoRequestsReceived
          expr: |
            sum (
              rate(
                traces_span_metrics_calls_total{
                  service_name!~"flagd|load-generator",
                  status_code=~"STATUS_CODE_UNSET|STATUS_CODE_OK",
                  namespace="[[ applications_helm_releases.otel_demo.namespace ]]"
                }[10m]
              )
            ) by (service_name, namespace)
            == 0
          for: 10m
          labels:
            severity: critical
          annotations:
            description: "Service {{ $labels.service_name }} in namespace {{ $labels.namespace }} has received no requests"