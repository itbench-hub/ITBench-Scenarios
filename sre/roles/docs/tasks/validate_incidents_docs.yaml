---
- name: Find all incident specs
  ansible.builtin.find:
    paths: "{{ playbook_dir }}/../roles/incidents/files/specs"
    pattern: "incident_*.yaml"
  register: docs_incident_spec_files

- name: Parse identifiers from spec files
  ansible.builtin.set_fact:
    docs_incidents_ids: "{{ (docs_incidents_ids | default([])) + [spec.metadata.id] }}"
  loop: "{{ docs_incident_spec_files.files }}"
  loop_control:
    label: "{{ item.path }}"
  vars:
    spec: "{{ lookup('ansible.builtin.file', item.path) | from_yaml }}"

- name: Include the incidents role to run the validation on all incidents
  ansible.builtin.include_role:
    name: incidents
    apply:
      tags:
        - validate_docs
  loop: "{{ docs_incidents_ids }}"
  loop_control:
    label: "incident-{{ item }}"
  vars:
    incident_id: "{{ item }}"
