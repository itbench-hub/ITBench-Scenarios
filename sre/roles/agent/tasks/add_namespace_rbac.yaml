---
- name: Create verbs dictionary
  ansible.builtin.set_fact:
    agent_access_verbs:
      read-only:
        - "get"
        - "list"
      read-write:
        - "*"
- name: Retrieve information about namespace
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Namespace
    kubeconfig: "{{ agent_cluster.kubeconfig }}"
    name: "{{ ns.name }}"
  register: agent_namespace_info

- name: Retrieve Service Accounts for namespaces
  kubernetes.core.k8s_info:
    api_version: v1
    kind: ServiceAccount
    kubeconfig: "{{ agent_cluster.kubeconfig }}"
    label_selectors:
      - app.kubernetes.io/component = access-provider
      - app.kubernetes.io/part-of = it-bench
  register: agent_service_account_info

- name: Create RBAC objects
  when:
    - agent_namespace_info.resources | length == 1
  block:
    - name: Create Role
      kubernetes.core.k8s:
        kubeconfig: "{{ agent_cluster.kubeconfig }}"
        namespace: "{{ ns.name }}"
        template: templates/role.j2
        state: present
      register: agent_role
      vars:
        verbs: "{{ agent_access_verbs[ns.access] }}"

    - name: Create RoleBinding
      kubernetes.core.k8s:
        kubeconfig: "{{ agent_cluster.kubeconfig }}"
        namespace: "{{ ns.name }}"
        template: templates/rolebinding.j2
        state: present
      vars:
        role: "{{ agent_role.result }}"
        service_account: "{{ agent_service_account_info.resources | first }}"
