---
- name: Create Service Account
  kubernetes.core.k8s:
    kubeconfig: "{{ agent_cluster.kubeconfig }}"
    resource_definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        labels:
          app.kubernetes.io/component: access-provider
          app.kubernetes.io/part-of: it-bench
        name: agent
        namespace: "{{ (agent_namespaces | first).name }}"
    state: present
  tags:
    - grant_access

- name: Include tasks for granting agent access to namespaces
  ansible.builtin.include_tasks:
    file: add_namespace_rbac.yaml
    apply:
      tags:
        - grant_access
  loop: "{{ agent_namespaces }}"
  loop_control:
    label: namespace/{{ ns.name }}
    loop_var: ns
  tags:
    - grant_access

- name: Include tasks for restricted kubeconfig generation
  ansible.builtin.include_tasks:
    file: generate_restricted_kubeconfig.yaml
    apply:
      tags:
        - grant_access
  tags:
    - grant_access
  when:
    - agent_namespaces | length > 0

- name: Include tasks for revoking agent access to namespaces
  ansible.builtin.include_tasks:
    file: remove_namespace_rbac.yaml
    apply:
      tags:
        - revoke_access
  tags:
    - revoke_access
