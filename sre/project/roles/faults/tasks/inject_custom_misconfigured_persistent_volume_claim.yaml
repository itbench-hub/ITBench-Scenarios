---
- name: Create invalid Persistent Volume Claim
  kubernetes.core.k8s:
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
    resource_definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: "{{ spec.workload.name }}-invalid"
        namespace: "{{ spec.workload.namespace }}"
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 25Mi
        storageClassName: invalid-class-name
    state: present

- name: Import variable setting tasks
  ansible.builtin.import_tasks:
    file: set_faults_workload_container_index.yaml
  vars:
    faults_workload: "{{ spec.workload }}"

- name: Inject fault (misconfigured persistent volume claim)
  kubernetes.core.k8s_json_patch:
    api_version: apps/v1
    kind: "{{ spec.workload.kind }}"
    kubeconfig: "{{ faults_cluster.kubeconfig }}"
    name: "{{ spec.workload.name }}"
    namespace: "{{ spec.workload.namespace }}"
    patch:
      - op: add
        path: /spec/containers/{{ faults_workload_container_index }}/volumes
        value: { "persistentVolumeClaim": { "claimName": "{{ spec.workload.name }}-invalid" }, "name": "invalid-volume" }
