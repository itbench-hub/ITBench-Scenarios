---
- name: Retrieve all kubelet-serving certificates
  kubernetes.core.k8s_info:
    api_version: certificates.k8s.io/v1
    kind: CertificateSigningRequest
    kubeconfig: "{{ cluster_files.kubeconfig }}"
    field_selectors:
      - spec.signerName=kubernetes.io/kubelet-serving
    wait: true
  register: cluster_csr_info

- name: Approve pending certificates
  ansible.builtin.command:
    argv:
      - kubectl
      - certificate
      - approve
      - "{{ item.metadata.name }}"
      - "--kubeconfig={{ cluster_files.kubeconfig | ansible.builtin.expanduser }}"
  register: cluster_certs_approve_output
  changed_when: cluster_certs_approve_output.rc == 0
  loop: "{{ cluster_csr_info.resources }}"
  loop_control:
    label: "csr/{{ item.metadata.name }}"
  when:
    - item.status.conditions is not defined

- name: Wait for approvals to clear
  kubernetes.core.k8s_info:
    api_version: certificates.k8s.io/v1
    kind: CertificateSigningRequest
    kubeconfig: "{{ cluster_files.kubeconfig }}"
    name: "{{ item.metadata.name }}"
    wait: true
    wait_condition:
      type: Approved
      status: "True"
  loop: "{{ cluster_csr_info.resources }}"
  loop_control:
    label: "csr/{{ item.metadata.name }}"
  when:
    - item.status.conditions is not defined
