---
- name: Include tasks to approve pending certificate requests
  ansible.builtin.include_role:
    name: cluster
    tasks_from: approve_certificate_requests
  vars:
    cluster_files:
      kubeconfig: "{{ awx_cluster.kubeconfig }}"
  when:
    - awx_cluster.provider == "kind"

- name: Install AWX operator
  kubernetes.core.helm:
    chart_ref: awx-operator
    chart_repo_url: https://ansible-community.github.io/awx-operator-helm
    chart_version: 3.2.0
    create_namespace: true
    kubeconfig: "{{ awx_cluster.kubeconfig }}"
    release_name: "{{ awx_helm_releases.awx_operator.name }}"
    release_namespace: "{{ awx_helm_releases.awx_operator.namespace }}"
    release_state: present
    timeout: 10m0s
    wait: true

- name: Create experiment data PersistentVolume
  kubernetes.core.k8s:
    kubeconfig: "{{ awx_cluster.kubeconfig }}"
    resource_definition:
      apiVersion: v1
      kind: PersistentVolume
      metadata:
        name: experiment-data-pv
      spec:
        capacity:
          storage: 1Gi
        accessModes:
          - ReadWriteMany
        hostPath:
          path: /mnt/experiment-data
          type: DirectoryOrCreate
        persistentVolumeReclaimPolicy: Retain
    state: present
  when:
    - awx_cluster.provider == "kind"

- name: Create experiment data PersistentVolumeClaim
  kubernetes.core.k8s:
    kubeconfig: "{{ awx_cluster.kubeconfig }}"
    resource_definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: experiment-data-pvc
        namespace: "{{ awx_helm_releases.awx_operator.namespace }}"
      spec:
        accessModes:
          - ReadWriteMany
        resources:
          requests:
            storage: 1Gi
        volumeName: experiment-data-pv
        storageClassName: ""
    state: present
  when:
    - awx_cluster.provider == "kind"

- name: Install AWX
  kubernetes.core.k8s:
    kubeconfig: "{{ awx_cluster.kubeconfig }}"
    namespace: "{{ awx_helm_releases.awx_operator.namespace }}"
    src: files/awx_spec/{{ spec_file_name }}.yaml
    state: present
    wait: true
    wait_condition:
      reason: Successful
      status: "True"
      type: Successful
    wait_timeout: 900
  vars:
    spec_file_name: "{{ 'kind' if awx_cluster.provider == 'kind' else 'base' }}"
