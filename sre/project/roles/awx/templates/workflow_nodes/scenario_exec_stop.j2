---
- identifier: node-handback-from-agent
  related:
    always_nodes:
      - identifier: node-remove-access-from-agent
{% if requires_aws_credentials %}
    credentials:
      - name: AWS
{% endif %}
  unified_job_template:
    name: Handback-From-Agent
    type: job_template
- identifier: node-remove-access-from-agent
  related:
    always_nodes:
      - identifier: node-install-run-topology-recorder-post-agent-execution
    credentials:
      - name: Cluster-{{ cluster_index + 1 }}-Kubeconfig
{% if requires_aws_credentials %}
      - name: AWS
{% endif %}
  unified_job_template:
    name: Remove-Access-From-Agent
    type: job_template
- identifier: node-install-run-topology-recorder-post-agent-execution
  extra_data:
    recorders_awx_topology_filename_prefix: end
  related:
    always_nodes:
      - identifier: node-pause-post-agent-execution
    credentials:
      - name: Cluster-{{ cluster_index + 1 }}-Kubeconfig
{% if requires_aws_credentials %}
      - name: AWS
{% endif %}
  unified_job_template:
    name: Run-Topology-Data-Recorder
    type: job_template
- identifier: node-pause-post-agent-execution
  related:
    always_nodes:
      - identifier: node-uninstall-recorders
  unified_job_template:
    name: Pause
    type: job_template
- identifier: node-uninstall-recorders
  extra_data:
    incident_id: {{ scenario_id }}
  related:
    always_nodes:
{% if fault_injection_index_count == 0 %}
      - identifier: node-undeploy-applications
{% else %}
{% for index in range(0, fault_injection_index_count) %}
      - identifier: node-remove-fault-{{ index + 1 }}
{% endfor %}
{% endif %}
    credentials:
      - name: Cluster-{{ cluster_index + 1 }}-Kubeconfig
{% if requires_aws_credentials %}
      - name: AWS
{% endif %}
  unified_job_template:
    name: Uninstall-Data-Recorders
    type: job_template
{% for index in range(0, fault_injection_index_count) %}
- identifier: node-remove-fault-{{ index + 1 }}
  extra_data:
    incident_id: {{ scenario_id }}
    injection_index: {{ index }}
  related:
    always_nodes:
      - identifier: node-undeploy-applications
    credentials:
      - name: Cluster-{{ cluster_index + 1 }}-Kubeconfig
{% if requires_aws_credentials %}
      - name: AWS
{% endif %}
  unified_job_template:
    name: Remove-Faults
    type: job_template
{% endfor %}
- identifier: node-undeploy-applications
  all_parents_must_converge: true
  extra_data:
    incident_id: {{ scenario_id }}
  related:
    always_nodes:
      - identifier: node-undeploy-tools
    credentials:
      - name: Cluster-{{ cluster_index + 1 }}-Kubeconfig
{% if requires_aws_credentials %}
      - name: AWS
{% endif %}
  unified_job_template:
    name: Undeploy-Applications
    type: job_template
- identifier: node-undeploy-tools
  extra_data:
    incident_id: {{ scenario_id }}
  related:
    credentials:
      - name: Cluster-{{ cluster_index + 1 }}-Kubeconfig
{% if requires_aws_credentials %}
      - name: AWS
{% endif %}
  unified_job_template:
    name: Undeploy-Tools
    type: job_template
