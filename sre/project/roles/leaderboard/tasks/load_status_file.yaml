---
- name: Load status as legacy assertion file from storage
  when:
    - not assertion_file_exists
  block:
    - name: Copy assertion file into local directory
      ansible.builtin.copy:
        dest: /tmp/assertion.json
        mode: "0644"
        src: "{{ leaderboard_storage.local.directory }}/assertion.json"
      when:
        - leaderboard_storage.local is defined

    - name: Upload assertion file to S3 bucket
      amazon.aws.s3_object:
        endpoint_url: "{{ leaderboard_storage.s3.endpoint }}"
        bucket: "{{ leaderboard_storage.s3.bucket }}"
        object: "/{{ leaderboard_storage.s3.directory }}/assertion.json"
        dest: /tmp/assertion.json
        mode: get
      when:
        - leaderboard_storage.s3 is defined
  vars:
    assertion_file_exists: "{{ '/tmp/assertion.json' is exists }}"

- name: Load status as status file from storage
  when:
    - not status_file_exists
  block:
    - name: Copy status file into local directory
      ansible.builtin.copy:
        dest: /tmp/status.json
        mode: "0644"
        src: "{{ leaderboard_storage.local.directory }}/status.json"
      when:
        - leaderboard_storage.local is defined

    - name: Upload status file to S3 bucket
      amazon.aws.s3_object:
        endpoint_url: "{{ leaderboard_storage.s3.endpoint }}"
        bucket: "{{ leaderboard_storage.s3.bucket }}"
        object: "/{{ leaderboard_storage.s3.directory }}/status.json"
        dest: /tmp/status.json
        mode: get
      when:
        - leaderboard_storage.s3 is defined
  vars:
    status_file_exists: "{{ '/tmp/status.json' is exists }}"

- name: Load assertion file contents
  ansible.builtin.set_fact:
    leaderboard_current_assertion: "{{ lookup('ansible.builtin.file', '/tmp/assertion.json') | from_json }}"
  vars:
    leaderboard_current_assertion_exists: "{{ '/tmp/assertion.json' is exists }}"
  when:
    - leaderboard_current_assertion_exists

- name: Load status file contents
  ansible.builtin.set_fact:
    leaderboard_current_status: "{{ lookup('ansible.builtin.file', '/tmp/status.json') | from_json }}"
  vars:
    leaderboard_current_status_exists: "{{ '/tmp/status.json' is exists }}"
  when:
    - leaderboard_current_status_exists
