name: Perform smoke tests for applications

on:
  pull_request:
    branches:
      - main
    paths:
      - sre/playbooks/manage_applications.yaml
      - sre/roles/applications/*

jobs:
  otel-demo:
    name: OpenTelemetry Demo (Astronomy Shop) Smoke Tests
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4.2.2
      - uses: actions/setup-python@v5.6.0
        with:
          python-version: '3.12'
      - uses: actions/setup-go@v5.5.0
        with:
          go-version-file: sre/dev/local_cluster/go.mod
          cache-dependency-path: sre/dev/local_cluster/go.sum
      - uses: azure/setup-helm@v4.3.0
        with:
          version: v3.18.3
      - name: Install Python and Ansible dependencies
        run: |
          pip install -r sre/requirements.txt
          ansible-galaxy install -r sre/requirements.yaml
      - name: Create Kind cluster
        run: |
          make -C sre/dev/local_cluster create_cluster
      - name: Create group vars
        run: |
          make -C sre group_vars
          echo "applications: { otel_demo: true }" > sre/group_vars/environment/applications.yaml
          echo "tools: { clickhouse: true, jaeger: true, prometheus: true }" > sre/group_vars/environment/tools.yaml
      - name: Install tools
        run: |
          make -C sre deploy_tools
      - name: Run installation smoke test
        run: |
          make -C sre deploy_applications
      - name: Run uninstallation smoke test
        run: |
          make -C sre undeploy_applications
